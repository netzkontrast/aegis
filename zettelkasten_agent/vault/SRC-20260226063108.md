---
id: SRC-20260226063108
created: '2026-02-26T06:31:08.499619'
tags:
- '#docs'
- '#plans'
- '#writing'
- '#quest/writing-excellence'
- '#quest/narrative-architecture'
- '#quest/narrative-system'
- '#quest/roman-entwicklung-implementation'
- '#quest/system-aegis'
- '#quest/ncp-writing-assistant'
- '#quest/documentation-improvements'
- '#quest/skill-gap-analysis'
- '#quest/style-and-meta'
- '#quest/integrate-writing-excellence'
- '#quest/system-protagonist'
- '#quest/knowledge-graph-foundation'
- '#quest/system-maintenance'
- '#quest/world-physics'
links: []
note_type: SRC
source_uri: docs/plans/2025-11-05-ncp-writing-assistant.md
status: processed
---

# NCP Writing Assistant Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build `ncp_assist.py`, a CLI tool that generates writing prompts, character voice samples, and scene starter suggestions based on NCP data

**Architecture:** Follows the established pattern from `ncp_query.py` - uses NCPManager for data access, argparse for CLI, dataclasses for structured output. Extends with prompt generation logic and voice sample extraction.

**Tech Stack:** Python 3.10+, argparse (CLI), json (NCP parsing), dataclasses (structured data), no external dependencies

---

## Task 1: Create Test File Structure

**Files:**
- Create: `tests/test_ncp_assist.py`
- Reference: `ARCHON/tools/ncp_query.py` (for patterns)
- Reference: `ARCHON/ncp/kohaerenz_protokoll.ncp.json` (test data)

**Step 1: Write the failing test for basic CLI structure**

```python
#!/usr/bin/env python3
"""Tests for ncp_assist.py"""

import sys
import subprocess
from pathlib import Path

def test_help_flag_works():
    """Test that --help flag displays usage"""
    result = subprocess.run(
        ["python", "ARCHON/tools/ncp_assist.py", "--help"],
        capture_output=True,
        text=True
    )
    assert result.returncode == 0
    assert "NCP Writing Assistant" in result.stdout
    assert "--chapter" in result.stdout
```

**Step 2: Run test to verify it fails**

Run: `pytest tests/test_ncp_assist.py::test_help_flag_works -v`
Expected: FAIL with "No such file or directory: 'ARCHON/tools/ncp_assist.py'"

**Step 3: Create minimal ncp_assist.py skeleton**

```python
#!/usr/bin/env python3
"""
NCP Writing Assistant - MVP Implementation

Generates writing prompts and character voice samples from NCP.

Usage:
    python ncp_assist.py --chapter 4 --prompt
    python ncp_assist.py --character Lex --voice-sample
"""

import sys
import argparse
from pathlib import Path

def main():
    parser = argparse.ArgumentParser(
        description="NCP Writing Assistant - Generate prompts and voice samples"
    )
    parser.add_argument("--chapter", type=int, help="Chapter number")
    parser.add_argument("--prompt", action="store_true", help="Generate writing prompt")
    parser.add_argument("--character", type=str, help="Character name for voice sample")
    parser.add_argument("--voice-sample", action="store_true", help="Generate voice sample")

    args = parser.parse_args()

    print("NCP Writing Assistant")

if __name__ == "__main__":
    main()
```

**Step 4: Make file executable and run test**

Run: `chmod +x ARCHON/tools/ncp_assist.py && pytest tests/test_ncp_assist.py::test_help_flag_works -v`
Expected: PASS

**Step 5: Commit**

```bash
git add tests/test_ncp_assist.py ARCHON/tools/ncp_assist.py
git commit -m "feat: add ncp_assist.py skeleton with basic CLI"
```

---

## Task 2: Implement Prompt Generation for Chapters

**Files:**
- Modify: `ARCHON/tools/ncp_assist.py`
- Modify: `tests/test_ncp_assist.py`

**Step 1: Write test for chapter prompt generation**

```python
def test_chapter_prompt_generation():
    """Test that --chapter --prompt generates a writing prompt"""
    result = subprocess.run(
        ["python", "ARCHON/tools/ncp_assist.py", "--chapter", "4", "--prompt"],
        capture_output=True,
        text=True
    )
    assert result.returncode == 0
    assert "WRITING PROMPT" in result.stdout
    assert "Chapter 4" in result.stdout
    assert "Thematic Goal" in result.stdout
```

**Step 2: Run test to verify it fails**

Run: `pytest tests/test_ncp_assist.py::test_chapter_prompt_generation -v`
Expected: FAIL with missing "WRITING PROMPT" in output

**Step 3: Import NCPManager and add PromptGenerator class**

Add to `ncp_assist.py` after imports:

```python
from ncp_query import NCPManager
from dataclasses import dataclass
from typing import List, Dict, Optional
import json

@dataclass
class WritingPrompt:
    """Structured writing prompt data"""
    chapter: int
    scene_suggestions: List[str]
    thematic_goal: str
    active_alters: List[str]
    location: str
    prose_style: str
    starter_lines: List[str]

class PromptGenerator:
    """Generates writing prompts from NCP data"""

    def __init__(self, ncp: NCPManager):
        self.ncp = ncp

    def generate_chapter_prompt(self, chapter: int) -> WritingPrompt:
        """Generate a writing prompt for a chapter"""
        chapter_info = self.ncp.get_chapter_info(chapter)

        # Get first scene in chapter as example
        scenes = [s for s in self.ncp.structural_framework.get('scenes', [])
                  if s.get('chapter') == chapter]

        if not scenes:
            raise ValueError(f"No scenes found for chapter {chapter}")

        first_scene = scenes[0]

        # Generate starter lines (placeholder for now)
        starter_lines = self._generate_starter_lines(first_scene, chapter_info)

        return WritingPrompt(
            chapter=chapter,
            scene_suggestions=[s.get('title', 'Untitled') for s in scenes],
            thematic_goal=chapter_info.get('thematic_focus', 'Unknown'),
            active_alters=first_scene.get('active_alters', []),
            location=first_scene.get('location', 'Unknown'),
            prose_style=first_scene.get('prose_style', 'Unknown'),
            starter_lines=starter_lines
        )

    def _generate_starter_lines(self, scene: Dict, chapter_info: Dict) -> List[str]:
        """Generate 3 opening line suggestions"""
        location = scene.get('location', 'the location')
        pov = scene.get('pov_character', 'the character')

        return [
            f"The first time {pov} entered {location}, everything felt wrong.",
            f"{pov} knew returning to {location} was a mistake.",
            f"The air in {location} tasted of memory and salt."
        ]
```

**Step 4: Update main() to call PromptGenerator**

Replace the print statement in main() with:

```python
def main():
    parser = argparse.ArgumentParser(
        description="NCP Writing Assistant - Generate prompts and voice samples"
    )
    parser.add_argument("--chapter", type=int, help="Chapter number")
    parser.add_argument("--prompt", action="store_true", help="Generate writing prompt")
    parser.add_argument("--character", type=str, help="Character name for voice sample")
    parser.add_argument("--voice-sample", action="store_true", help="Generate voice sample")
    parser.add_argument("--ncp", type=Path, default=None, help="Path to NCP file")

    args = parser.parse_args()

    # Find NCP file
    ncp_path = args.ncp or Path("ARCHON/ncp/kohaerenz_protokoll.ncp.json")
    if not ncp_path.exists():
        print(f"ERROR: NCP file not found at {ncp_path}", file=sys.stderr)
        sys.exit(1)

    # Load NCP
    ncp = NCPManager(ncp_path)
    generator = PromptGenerator(ncp)

    # Generate prompt if requested
    if args.prompt and args.chapter:
        prompt = generator.generate_chapter_prompt(args.chapter)
        print_prompt(prompt)
    else:
        print("ERROR: Must specify --chapter with --prompt", file=sys.stderr)
        sys.exit(1)

def print_prompt(prompt: WritingPrompt):
    """Pretty-print a writing prompt"""
    print("=" * 60)
    print(f"WRITING PROMPT: Chapter {prompt.chapter}")
    print("=" * 60)
    print(f"\nThematic Goal: {prompt.thematic_goal}")
    print(f"Location: {prompt.location}")
    print(f"Prose Style: {prompt.prose_style}")
    print(f"\nActive Alters: {', '.join(prompt.active_alters)}")
    print(f"\nScene Suggestions:")
    for i, scene in enumerate(prompt.scene_suggestions, 1):
        print(f"  {i}. {scene}")
    print(f"\nStarter Line Options:")
    for i, line in enumerate(prompt.starter_lines, 1):
        print(f"  {i}. \"{line}\"")
    print("=" * 60)
```

**Step 5: Run test to verify it passes**

Run: `pytest tests/test_ncp_assist.py::test_chapter_prompt_generation -v`
Expected: PASS

**Step 6: Commit**

```bash
git add ARCHON/tools/ncp_assist.py tests/test_ncp_assist.py
git commit -m "feat: implement chapter prompt generation in ncp_assist"
```

---

## Task 3: Implement Character Voice Samples

**Files:**
- Modify: `ARCHON/tools/ncp_assist.py`
- Modify: `tests/test_ncp_assist.py`

**Step 1: Write test for voice sample generation**

```python
def test_voice_sample_generation():
    """Test that --character --voice-sample generates voice samples"""
    result = subprocess.run(
        ["python", "ARCHON/tools/ncp_assist.py",
         "--character", "Lex", "--voice-sample"],
        capture_output=True,
        text=True
    )
    assert result.returncode == 0
    assert "CHARACTER VOICE SAMPLE" in result.stdout
    assert "Lex" in result.stdout
    assert "Type:" in result.stdout
    assert "Voice Characteristics:" in result.stdout
```

**Step 2: Run test to verify it fails**

Run: `pytest tests/test_ncp_assist.py::test_voice_sample_generation -v`
Expected: FAIL because voice sample generation not implemented

**Step 3: Add VoiceSample dataclass and generation method**

Add to `ncp_assist.py`:

```python
@dataclass
class VoiceSample:
    """Character voice sample data"""
    character_name: str
    character_type: str  # ANP, EP, ISH
    function: str
    voice_characteristics: Dict[str, str]
    example_lines: List[str]
    forbidden_patterns: List[str]

class PromptGenerator:
    # ... existing code ...

    def generate_voice_sample(self, character_name: str, chapter: int = None) -> VoiceSample:
        """Generate character voice sample from NCP"""
        # Find character in character_systems
        characters = self.ncp.character_systems.get('alters', [])
        character_data = None

        for char in characters:
            if char.get('name', '').lower() == character_name.lower():
                character_data = char
                break

        if not character_data:
            raise ValueError(f"Character '{character_name}' not found in NCP")

        # Get character state at chapter if specified
        arc_state = "Initial state"
        if chapter:
            state = self.ncp.get_character_state(character_name, chapter)
            if state:
                arc_state = state.arc_state

        # Extract voice characteristics
        voice_chars = {
            "Syntax": character_data.get('voice_patterns', {}).get('syntax', 'Unknown'),
            "Vocabulary": character_data.get('voice_patterns', {}).get('vocabulary', 'Unknown'),
            "Tone": character_data.get('voice_patterns', {}).get('tone', 'Unknown')
        }

        # Generate example lines based on type
        example_lines = self._generate_example_lines(character_data)

        # Extract forbidden patterns
        forbidden = self._extract_forbidden_patterns(character_data)

        return VoiceSample(
            character_name=character_name,
            character_type=character_data.get('type', 'Unknown'),
            function=character_data.get('function', 'Unknown'),
            voice_characteristics=voice_chars,
            example_lines=example_lines,
            forbidden_patterns=forbidden
        )

    def _generate_example_lines(self, character_data: Dict) -> List[str]:
        """Generate example dialogue lines"""
        char_type = character_data.get('type', '')
        name = character_data.get('name', 'Character')

        # Type-specific examples
        if char_type == 'ANP':
            return [
                f"We need to analyze this systematically. ({name})",
                f"Consider the logical implications first. ({name})",
                f"My assessment indicates a 73% probability of failure. ({name})"
            ]
        elif char_type == 'EP':
            return [
                f"*feels the cold water rising* ({name})",
                f"I remember... it was dark... ({name})",
                f"*small voice* Don't make me go back there. ({name})"
            ]
        else:  # ISH
            return [
                f"The system requires balance. ({name})",
                f"You are both correct. And both wrong. ({name})",
                f"I observe the patterns you cannot see. ({name})"
            ]

    def _extract_forbidden_patterns(self, character_data: Dict) -> List[str]:
        """Extract what this character should NEVER say/do"""
        char_type = character_data.get('type', '')

        forbidden = []
        if char_type == 'ANP':
            forbidden.append("Direct emotional expression without analytical framing")
            forbidden.append("Paratactic (simple) syntax")
        elif char_type == 'EP':
            forbidden.append("Intellectual analysis without emotional grounding")
            forbidden.append("Long, complex sentences")

        return forbidden
```

**Step 4: Update main() to handle voice sample requests**

Replace the conditional in main():

```python
def main():
    # ... parser setup same as before ...

    args = parser.parse_args()

    # Find and load NCP
    ncp_path = args.ncp or Path("ARCHON/ncp/kohaerenz_protokoll.ncp.json")
    if not ncp_path.exists():
        print(f"ERROR: NCP file not found at {ncp_path}", file=sys.stderr)
        sys.exit(1)

    ncp = NCPManager(ncp_path)
    generator = PromptGenerator(ncp)

    # Route to appropriate function
    if args.prompt and args.chapter:
        prompt = generator.generate_chapter_prompt(args.chapter)
        print_prompt(prompt)
    elif args.voice_sample and args.character:
        voice = generator.generate_voice_sample(args.character, args.chapter)
        print_voice_sample(voice)
    else:
        parser.print_help()
        sys.exit(1)

def print_voice_sample(voice: VoiceSample):
    """Pretty-print a character voice sample"""
    print("=" * 60)
    print(f"CHARACTER VOICE SAMPLE: {voice.character_name}")
    print("=" * 60)
    print(f"\nType: {voice.character_type}")
    print(f"Function: {voice.function}")
    print(f"\nVoice Characteristics:")
    for key, value in voice.voice_characteristics.items():
        print(f"  {key}: {value}")
    print(f"\nExample Lines:")
    for line in voice.example_lines:
        print(f"  • {line}")
    print(f"\nForbidden Patterns:")
    for pattern in voice.forbidden_patterns:
        print(f"  ✗ {pattern}")
    print("=" * 60)
```

**Step 5: Run test to verify it passes**

Run: `pytest tests/test_ncp_assist.py::test_voice_sample_generation -v`
Expected: PASS

**Step 6: Commit**

```bash
git add ARCHON/tools/ncp_assist.py tests/test_ncp_assist.py
git commit -m "feat: implement character voice sample generation"
```

---

## Task 4: Add Scene-Specific Prompts

**Files:**
- Modify: `ARCHON/tools/ncp_assist.py`
- Modify: `tests/test_ncp_assist.py`

**Step 1: Write test for scene-specific prompts**

```python
def test_scene_specific_prompt():
    """Test that --scene generates detailed scene prompt"""
    result = subprocess.run(
        ["python", "ARCHON/tools/ncp_assist.py",
         "--scene", "1.4", "--prompt"],
        capture_output=True,
        text=True
    )
    assert result.returncode == 0
    assert "Scene 1.4" in result.stdout
    assert "Goal:" in result.stdout
    assert "Conflict:" in result.stdout
```

**Step 2: Run test to verify it fails**

Run: `pytest tests/test_ncp_assist.py::test_scene_specific_prompt -v`
Expected: FAIL because --scene flag doesn't exist

**Step 3: Add --scene flag and scene prompt generation**

Update parser in main():

```python
parser.add_argument("--scene", type=str, help="Scene ID (e.g., 1.4)")
```

Add scene prompt method to PromptGenerator:

```python
@dataclass
class ScenePrompt:
    """Detailed scene-specific prompt"""
    scene_id: str
    chapter: int
    title: str
    location: str
    pov_character: str
    active_alters: List[str]
    goal: str
    conflict: str
    outcome: str
    prose_style: str
    thematic_beats: List[str]
    world_rules: List[str]
    starter_lines: List[str]

class PromptGenerator:
    # ... existing code ...

    def generate_scene_prompt(self, scene_id: str) -> ScenePrompt:
        """Generate detailed prompt for specific scene"""
        scene_req = self.ncp.get_scene_requirements(scene_id)

        if not scene_req:
            raise ValueError(f"Scene {scene_id} not found in NCP")

        # Extract thematic beats
        thematic_beats = [
            cp.get('checkpoint', 'Unknown')
            for cp in scene_req.thematic_checkpoints
        ]

        # Extract world rules if present
        world_rules = []
        if scene_req.world_physics:
            world_rules = scene_req.world_physics.get('rules', [])

        # Generate context-aware starter lines
        starter_lines = [
            f"The {scene_req.location} was {['familiar', 'strange', 'threatening'][i % 3]}."
            for i in range(3)
        ]

        return ScenePrompt(
            scene_id=scene_req.scene_id,
            chapter=scene_req.chapter,
            title=scene_req.title or "Untitled",
            location=scene_req.location,
            pov_character=scene_req.pov_character,
            active_alters=scene_req.active_alters,
            goal=scene_req.goal,
            conflict=scene_req.conflict,
            outcome=scene_req.outcome,
            prose_style=scene_req.prose_style,
            thematic_beats=thematic_beats,
            world_rules=world_rules,
            starter_lines=starter_lines
        )
```

**Step 4: Update main() to handle scene prompts**

```python
def main():
    # ... parser and NCP loading ...

    if args.prompt:
        if args.scene:
            prompt = generator.generate_scene_prompt(args.scene)
            print_scene_prompt(prompt)
        elif args.chapter:
            prompt = generator.generate_chapter_prompt(args.chapter)
            print_prompt(prompt)
        else:
            print("ERROR: --prompt requires either --scene or --chapter")
            sys.exit(1)
    elif args.voice_sample and args.character:
        voice = generator.generate_voice_sample(args.character, args.chapter)
        print_voice_sample(voice)
    else:
        parser.print_help()
        sys.exit(1)

def print_scene_prompt(prompt: ScenePrompt):
    """Pretty-print a scene-specific prompt"""
    print("=" * 60)
    print(f"SCENE PROMPT: {prompt.scene_id} - {prompt.title}")
    print("=" * 60)
    print(f"\nChapter: {prompt.chapter}")
    print(f"Location: {prompt.location}")
    print(f"POV: {prompt.pov_character}")
    print(f"Prose Style: {prompt.prose_style}")
    print(f"\nActive Alters: {', '.join(prompt.active_alters)}")
    print(f"\nGoal: {prompt.goal}")
    print(f"Conflict: {prompt.conflict}")
    print(f"Outcome: {prompt.outcome}")
    print(f"\nThematic Beats to Hit:")
    for beat in prompt.thematic_beats:
        print(f"  □ {beat}")
    if prompt.world_rules:
        print(f"\nWorld Rules:")
        for rule in prompt.world_rules:
            print(f"  • {rule}")
    print(f"\nStarter Line Options:")
    for i, line in enumerate(prompt.starter_lines, 1):
        print(f"  {i}. \"{line}\"")
    print("=" * 60)
```

**Step 5: Run test to verify it passes**

Run: `pytest tests/test_ncp_assist.py::test_scene_specific_prompt -v`
Expected: PASS

**Step 6: Commit**

```bash
git add ARCHON/tools/ncp_assist.py tests/test_ncp_assist.py
git commit -m "feat: add scene-specific prompt generation"
```

---

## Task 5: Add JSON Output Option

**Files:**
- Modify: `ARCHON/tools/ncp_assist.py`
- Modify: `tests/test_ncp_assist.py`

**Step 1: Write test for JSON output**

```python
def test_json_output_format():
    """Test that --json flag produces valid JSON"""
    result = subprocess.run(
        ["python", "ARCHON/tools/ncp_assist.py",
         "--chapter", "4", "--prompt", "--json"],
        capture_output=True,
        text=True
    )
    assert result.returncode == 0

    # Should be valid JSON
    import json
    data = json.loads(result.stdout)
    assert "chapter" in data
    assert data["chapter"] == 4
```

**Step 2: Run test to verify it fails**

Run: `pytest tests/test_ncp_assist.py::test_json_output_format -v`
Expected: FAIL because --json not implemented

**Step 3: Add --json flag and JSON output**

Add to parser:

```python
parser.add_argument("--json", action="store_true", help="Output in JSON format")
```

Add JSON serialization helper:

```python
import json
from dataclasses import asdict

def output_json(data):
    """Output dataclass as JSON"""
    print(json.dumps(asdict(data), indent=2))
```

**Step 4: Update main() to respect --json flag**

```python
def main():
    # ... parser and NCP loading ...

    if args.prompt:
        if args.scene:
            prompt = generator.generate_scene_prompt(args.scene)
            if args.json:
                output_json(prompt)
            else:
                print_scene_prompt(prompt)
        elif args.chapter:
            prompt = generator.generate_chapter_prompt(args.chapter)
            if args.json:
                output_json(prompt)
            else:
                print_prompt(prompt)
        else:
            print("ERROR: --prompt requires either --scene or --chapter")
            sys.exit(1)
    elif args.voice_sample and args.character:
        voice = generator.generate_voice_sample(args.character, args.chapter)
        if args.json:
            output_json(voice)
        else:
            print_voice_sample(voice)
    else:
        parser.print_help()
        sys.exit(1)
```

**Step 5: Run test to verify it passes**

Run: `pytest tests/test_ncp_assist.py::test_json_output_format -v`
Expected: PASS

**Step 6: Commit**

```bash
git add ARCHON/tools/ncp_assist.py tests/test_ncp_assist.py
git commit -m "feat: add JSON output format option"
```

---

## Task 6: Add Integration Tests and Documentation

**Files:**
- Modify: `tests/test_ncp_assist.py`
- Modify: `ARCHON/tools/README.md`

**Step 1: Write integration test**

```python
def test_end_to_end_workflow():
    """Test complete workflow: chapter -> scene -> voice"""
    # Get chapter prompt
    result1 = subprocess.run(
        ["python", "ARCHON/tools/ncp_assist.py", "--chapter", "4", "--prompt"],
        capture_output=True,
        text=True
    )
    assert result1.returncode == 0

    # Get scene prompt
    result2 = subprocess.run(
        ["python", "ARCHON/tools/ncp_assist.py", "--scene", "1.4", "--prompt"],
        capture_output=True,
        text=True
    )
    assert result2.returncode == 0

    # Get voice sample
    result3 = subprocess.run(
        ["python", "ARCHON/tools/ncp_assist.py",
         "--character", "Lex", "--voice-sample"],
        capture_output=True,
        text=True
    )
    assert result3.returncode == 0
```

**Step 2: Run integration test**

Run: `pytest tests/test_ncp_assist.py::test_end_to_end_workflow -v`
Expected: PASS

**Step 3: Update ARCHON/tools/README.md**

Find the section "### 3. ncp_assist.py - Writing Assistant" and replace:

```markdown
### 3. ncp_assist.py - Writing Assistant ✅

Generate writing prompts and character voice samples from NCP.

**Status**: Implemented

**Usage**:

```bash
# Generate chapter-level writing prompt
python ncp_assist.py --chapter 4 --prompt

# Generate scene-specific prompt
python ncp_assist.py --scene 1.4 --prompt

# Get character voice sample
python ncp_assist.py --character Lex --voice-sample

# Get voice sample in context of specific chapter
python ncp_assist.py --character Lex --voice-sample --chapter 4

# Output as JSON for programmatic use
python ncp_assist.py --chapter 4 --prompt --json
```

**Features**:
- Chapter-level prompts with thematic goals and scene suggestions
- Scene-specific prompts with beats and world rules
- Character voice samples with examples and forbidden patterns
- JSON output for scripting

**Example Output**:

```bash
$ python ncp_assist.py --character Lex --voice-sample
============================================================
CHARACTER VOICE SAMPLE: Lex
============================================================

Type: ANP
Function: Analyst and intellectual controller

Voice Characteristics:
  Syntax: Hypotactic (complex, subordinate clauses)
  Vocabulary: Technical, analytical
  Tone: Detached, logical

Example Lines:
  • We need to analyze this systematically. (Lex)
  • Consider the logical implications first. (Lex)
  • My assessment indicates a 73% probability of failure. (Lex)

Forbidden Patterns:
  ✗ Direct emotional expression without analytical framing
  ✗ Paratactic (simple) syntax
============================================================
```
```

**Step 4: Run all tests to verify everything works**

Run: `pytest tests/test_ncp_assist.py -v`
Expected: All tests PASS

**Step 5: Commit**

```bash
git add tests/test_ncp_assist.py ARCHON/tools/README.md
git commit -m "test: add integration tests and update documentation"
```

---

## Task 7: Manual Verification and Edge Cases

**Step 1: Test with actual NCP file**

Run each command manually to verify output quality:

```bash
python ARCHON/tools/ncp_assist.py --chapter 1 --prompt
python ARCHON/tools/ncp_assist.py --scene 1.1 --prompt
python ARCHON/tools/ncp_assist.py --character Kael --voice-sample
python ARCHON/tools/ncp_assist.py --character Kiko --voice-sample
python ARCHON/tools/ncp_assist.py --chapter 4 --prompt --json | jq
```

**Step 2: Test error handling**

```bash
# Invalid chapter
python ARCHON/tools/ncp_assist.py --chapter 999 --prompt

# Invalid scene
python ARCHON/tools/ncp_assist.py --scene 99.99 --prompt

# Invalid character
python ARCHON/tools/ncp_assist.py --character NotReal --voice-sample

# Missing NCP file
python ARCHON/tools/ncp_assist.py --chapter 1 --prompt --ncp /fake/path.json
```

Expected: All should fail gracefully with clear error messages

**Step 3: Add error handling if needed**

Wrap main logic in try-except:

```python
def main():
    # ... parser setup ...

    try:
        # ... main logic ...
    except FileNotFoundError as e:
        print(f"ERROR: {e}", file=sys.stderr)
        sys.exit(1)
    except ValueError as e:
        print(f"ERROR: {e}", file=sys.stderr)
        sys.exit(1)
    except Exception as e:
        print(f"UNEXPECTED ERROR: {e}", file=sys.stderr)
        sys.exit(2)
```

**Step 4: Commit error handling improvements**

```bash
git add ARCHON/tools/ncp_assist.py
git commit -m "refactor: improve error handling and messages"
```

---

## Task 8: Final Polish and Documentation

**Files:**
- Modify: `ARCHON/tools/ncp_assist.py`

**Step 1: Add comprehensive docstrings**

Ensure main module docstring is complete:

```python
#!/usr/bin/env python3
"""
NCP Writing Assistant - MVP Implementation

Generates writing prompts, character voice samples, and scene guidance
from the Narrative Context Protocol (NCP) to aid writers.

Usage Examples:
    # Chapter-level prompt
    python ncp_assist.py --chapter 4 --prompt

    # Scene-specific prompt with all details
    python ncp_assist.py --scene 1.4 --prompt

    # Character voice sample
    python ncp_assist.py --character Lex --voice-sample

    # Voice sample in chapter context
    python ncp_assist.py --character Lex --voice-sample --chapter 4

    # JSON output for scripting
    python ncp_assist.py --chapter 4 --prompt --json

Features:
    - Chapter-level writing prompts with thematic guidance
    - Scene-specific prompts with goals, conflicts, and beats
    - Character voice samples with examples and constraints
    - JSON output for programmatic integration
    - Starter line suggestions for each prompt

Technical Notes:
    - Uses NCPManager from ncp_query.py for data access
    - No external dependencies beyond Python 3.10+ stdlib
    - Supports custom NCP file path via --ncp flag
"""
```

**Step 2: Add inline comments for complex logic**

Add comments to _generate_example_lines and other complex methods:

```python
def _generate_example_lines(self, character_data: Dict) -> List[str]:
    """Generate example dialogue lines based on character type"""
    char_type = character_data.get('type', '')
    name = character_data.get('name', 'Character')

    # ANP (Apparently Normal Part) - rational, analytical
    if char_type == 'ANP':
        return [
            # Analytical, hypotactic syntax
            f"We need to analyze this systematically. ({name})",
            # ...
        ]
    # EP (Emotional Part) - traumatized, sensory, childlike
    elif char_type == 'EP':
        # ...
```

**Step 3: Run final test suite**

Run: `pytest tests/test_ncp_assist.py -v --tb=short`
Expected: All tests PASS

**Step 4: Verify tool in ARCHON workflow**

Test the complete writing workflow from README:

```bash
# 1. Get chapter context
python ARCHON/tools/ncp_query.py --chapter 4 --verbose

# 2. Get writing prompt (NEW TOOL)
python ARCHON/tools/ncp_assist.py --chapter 4 --prompt

# 3. Get voice samples (NEW TOOL)
python ARCHON/tools/ncp_assist.py --character Lex --voice-sample
python ARCHON/tools/ncp_assist.py --character Kiko --voice-sample

# 4. Write scene (human)
# [Writer uses the prompts and voice samples]

# 5. Validate scene
python ARCHON/tools/ncp_validate.py manuscript/act_1/chapter_04.md
```

**Step 5: Final commit**

```bash
git add ARCHON/tools/ncp_assist.py
git commit -m "docs: add comprehensive documentation and comments"
```

---

## Verification Checklist

Before considering this task complete, verify:

- [ ] `pytest tests/test_ncp_assist.py -v` - all tests pass
- [ ] `python ARCHON/tools/ncp_assist.py --help` - shows comprehensive help
- [ ] `python ARCHON/tools/ncp_assist.py --chapter 1 --prompt` - generates readable prompt
- [ ] `python ARCHON/tools/ncp_assist.py --scene 1.1 --prompt` - generates scene prompt
- [ ] `python ARCHON/tools/ncp_assist.py --character Kael --voice-sample` - shows voice
- [ ] `python ARCHON/tools/ncp_assist.py --chapter 1 --prompt --json` - valid JSON
- [ ] Error handling works for invalid inputs (chapter 999, scene 99.99, character NotReal)
- [ ] Tool works without external dependencies (only Python 3.10+ stdlib)
- [ ] Documentation in README.md updated
- [ ] All code follows existing style from ncp_query.py and ncp_validate.py

---

## Success Criteria

**Tool is complete when:**

1. All unit and integration tests pass
2. Manual testing shows high-quality prompts and voice samples
3. Tool integrates smoothly into existing ARCHON workflow
4. No external dependencies required
5. Documentation is complete and accurate
6. Error messages are clear and helpful
7. JSON output is valid and parseable
8. Code follows DRY and YAGNI principles

**Total estimated time:** 2-3 hours for experienced Python developer with zero codebase context

---

## Notes for Engineer

**Key Design Decisions:**

1. **Reuses NCPManager**: Don't duplicate NCP loading logic - import from ncp_query.py
2. **Dataclasses for structure**: Follows existing pattern from ncp_query.py
3. **Type-based voice generation**: Uses character type (ANP/EP/ISH) to generate appropriate examples
4. **Starter lines are simple**: Not LLM-generated - just template-based placeholders
5. **JSON output for scripting**: Enables programmatic use and future integrations

**Testing Philosophy:**

- Unit tests for each major function
- Integration test for end-to-end workflow
- Manual verification for quality
- Error handling tests for edge cases

**What's NOT included** (future enhancements):

- LLM-based prompt refinement
- Context from Knowledge Graph (Phase 2)
- Style transfer from existing chapters
- Interactive prompt builder
- Batch generation for entire acts

**Reference Documentation:**

- `ARCHON/INTERFACE_DESIGN.md:113-214` - Design spec for Writing Assistant
- `ARCHON/tools/ncp_query.py` - Code patterns to follow
- `ARCHON/tools/ncp_validate.py` - Testing patterns to follow
- `ARCHON/ncp/kohaerenz_protokoll.ncp.json` - Test data source
